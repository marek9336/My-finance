<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Finance - Settings</title>
  <link rel="stylesheet" href="/ui/common.css" />
  <style>
    .check { display:flex; align-items:center; gap:8px; margin-top:8px; }
    .check input { width:18px; height:18px; margin:0; }
    textarea { min-height:220px; }
    .danger { border:1px solid var(--err); }
    .danger button { background:var(--err); border-color:var(--err); color:#fff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="topbar">
        <div class="top-left">
          <h1 id="title">Settings</h1>
          <p id="subtitle">Language, timezone, appearance, backup and translations.</p>
          <div class="menu-row">
            <a href="/ui/dashboard" id="navOverview">Overview</a>
            <a href="/ui/transactions" id="navTransactions">Transactions</a>
            <a href="/ui/savings-investments" id="navInvestments">Savings & Investments</a>
            <a href="/ui/rates" id="navRates">Rates</a>
            <a href="/ui/services" id="navServices">Services</a>
            </div>
        </div>
        <div class="top-actions">
          <div class="user-menu">
            <button id="userBtn" type="button">...</button>
            <div class="dropdown" id="userMenu">
              <a href="/ui/settings" id="menuSettingsLink">Settings</a>
              <button id="logoutBtn" class="logout" type="button">Logout</button>
            </div>
          </div>
        </div>
      </div>
      <div id="msg" class="msg"></div>
    </div>

    <div class="card">
      <h2 id="generalTitle">General</h2>
      <div class="grid">
        <div><label id="labelLang" for="locale">Language</label><select id="locale"></select></div>
        <div><label id="labelProvider" for="provider">Calendar provider</label><select id="provider"><option value="google">google</option><option value="none">none</option></select></div>
        <div><label id="labelTz" for="tz">Timezone</label><select id="tz"></select><button class="btn" id="detectTzBtn" type="button">Detect Timezone</button></div>
        <div><label id="labelTheme" for="theme">Appearance</label><select id="theme"><option value="system">System</option><option value="light">Light</option><option value="dark">Dark</option></select></div>
        <div><label id="labelLayout" for="layoutWidth">Layout width</label><select id="layoutWidth"><option value="full">Full width</option><option value="limited">Limited width</option></select></div>
      </div>
      <div class="check"><input type="checkbox" id="syncEnabled"><label id="labelSync" for="syncEnabled">Calendar sync enabled</label></div>
      <div class="check"><input type="checkbox" id="registrationEnabled"><label id="labelReg" for="registrationEnabled">Self registration enabled</label></div>
      <div class="check"><input type="checkbox" id="smtpEnabled"><label id="labelSmtp" for="smtpEnabled">SMTP enabled</label></div>
      <div class="grid"><div><label id="labelSessionTimeout" for="sessionTimeout">Auto logout</label><select id="sessionTimeout"><option value="5">5 min</option><option value="60">1 hour</option><option value="1440">1 day</option><option value="never">Never</option></select></div></div>
      <button id="saveGeneralBtn" type="button">Save Settings</button>
    </div>

    <div class="card">
      <h2 id="profileTitle">Profile</h2>
      <div class="grid">
        <div><label id="labelProfileEmail" for="profileEmail">Email</label><input id="profileEmail" type="email" /></div>
        <div><label id="labelProfileName" for="profileName">Display name</label><input id="profileName" /></div>
      </div>
      <button id="saveProfileBtn" type="button">Save Profile</button>
      <div class="grid">
        <div><label id="labelCurrentPassword" for="currentPassword">Current password</label><input id="currentPassword" type="password" /></div>
        <div><label id="labelNewPassword" for="newPassword">New password</label><input id="newPassword" type="password" /></div>
      </div>
      <button id="changePasswordBtn" type="button">Change Password</button>
    </div>

    <div class="card">
      <h2 id="backupTitle">Backup</h2>
      <div class="check"><input type="checkbox" id="autoBackupEnabled"><label id="labelAuto" for="autoBackupEnabled">Enable automatic backups</label></div>
      <div class="grid">
        <div><label id="labelInterval" for="backupInterval">Backup interval (minutes)</label><input id="backupInterval" type="number" min="5" step="1"></div>
        <div><label id="labelRetention" for="backupRetention">Retention (days)</label><input id="backupRetention" type="number" min="1" step="1"></div>
      </div>
      <div class="menu-row">
        <button id="saveBackupBtn" type="button">Save Backup Settings</button>
        <button id="downloadBtn" type="button">Download Backup</button>
        <button id="runNowBtn" type="button">Run Backup Now</button>
      </div>
      <div class="menu-row">
        <input id="backupFile" type="file" accept=".json,application/json" />
        <button id="restoreBtn" type="button">Restore From File</button>
      </div>
    </div>

    <div class="card">
      <h2 id="translationsTitle">Translations</h2>
      <div class="menu-row"><label id="labelLocale" for="translationLocale">Locale</label><select id="translationLocale" style="max-width:240px"></select></div>
      <textarea id="translationJson">{}</textarea>
      <div class="menu-row"><button id="saveTranslationsBtn" type="button">Save Custom</button><button id="publishTranslationsBtn" type="button">Publish To File</button></div>
    </div>

    <div class="card danger">
      <h2 id="accountTitle">Account</h2>
      <p id="accountDeleteInfo">Deleting account removes all your data. You can create backup first.</p>
      <button id="deleteAccountBtn" type="button">Delete Account</button>
    </div>

    <footer id="footerText">Copyright (c) My-Finance. Experimental software. Verify data and recommendations before acting.</footer>
  </div>

  <script src="/ui/common.js"></script>
  <script>
    const t = (k, f="") => MFUI.t(k, f);

    function offsetText(minutes){ const sign=minutes<0?"-":"+"; const abs=Math.abs(minutes); const h=String(Math.floor(abs/60)).padStart(2,"0"); const m=String(abs%60).padStart(2,"0"); return `UTC${sign}${h}:${m}`; }
    function timezoneRows(){ return [{value:"UTC",offset:0,labelEn:"UTC / London",labelCs:"UTC / Londyn"},{value:"Europe/Prague",offset:60,labelEn:"Prague / Paris / Budapest",labelCs:"Praha / Paříž / Budapešť"},{value:"Europe/Athens",offset:120,labelEn:"Athens / Bucharest / Sofia",labelCs:"Atény / Bukurešť / Sofie"},{value:"Asia/Dubai",offset:240,labelEn:"Dubai / Baku",labelCs:"Dubaj / Baku"},{value:"Asia/Tokyo",offset:540,labelEn:"Tokyo / Seoul",labelCs:"Tokio / Soul"},{value:"America/New_York",offset:-300,labelEn:"New York / Toronto",labelCs:"New York / Toronto"},{value:"America/Chicago",offset:-360,labelEn:"Chicago / Mexico City",labelCs:"Chicago / Mexico City"},{value:"America/Los_Angeles",offset:-480,labelEn:"Los Angeles / Vancouver",labelCs:"Los Angeles / Vancouver"}]; }
    function detectSystemTimezone(){ try { return Intl.DateTimeFormat().resolvedOptions().timeZone || "Europe/Prague"; } catch(_) { return "Europe/Prague"; } }
    function fillTimezoneSelect(selected){ const sel=document.getElementById("tz"); sel.innerHTML=""; timezoneRows().forEach((z)=>{ const o=document.createElement("option"); o.value=z.value; const city=(localStorage.getItem("mf_lang")||"en")==="cs"?z.labelCs:z.labelEn; o.textContent=`(${offsetText(z.offset)}) ${city}`; sel.appendChild(o); }); if(![...sel.options].some((o)=>o.value===selected)){ const o=document.createElement("option"); o.value=selected; o.textContent=selected; sel.appendChild(o); } sel.value=selected; }

    function applyTexts(){
      document.title = t("settings.title", "Settings");
      document.getElementById("title").textContent = t("settings.title", "Settings");
      document.getElementById("subtitle").textContent = t("settings.subtitle", "Language, timezone, appearance, backup and translations.");
      document.getElementById("generalTitle").textContent = t("settings.general", "General");
      document.getElementById("labelLang").textContent = t("common.language", "Language");
      document.getElementById("labelProvider").textContent = t("settings.calendar_provider", "Calendar provider");
      document.getElementById("labelTz").textContent = t("common.timezone", "Timezone");
      document.getElementById("detectTzBtn").textContent = t("common.detect_timezone", "Detect Timezone");
      document.getElementById("labelTheme").textContent = t("common.appearance", "Appearance");
      document.getElementById("labelLayout").textContent = t("layoutWidth", "Layout width");
      const lw=document.getElementById("layoutWidth"); lw.options[0].textContent=t("layoutFull","Full width"); lw.options[1].textContent=t("layoutLimited","Limited width");
      document.getElementById("labelSync").textContent = t("settings.sync", "Calendar sync enabled");
      document.getElementById("labelReg").textContent = t("settings.registration_enabled", "Self registration enabled");
      document.getElementById("labelSmtp").textContent = t("settings.smtp", "SMTP enabled");
      document.getElementById("labelSessionTimeout").textContent = t("settings.session_timeout", "Auto logout");
      const st=document.getElementById("sessionTimeout"); st.options[0].textContent=t("settings.session_timeout_5","5 min"); st.options[1].textContent=t("settings.session_timeout_60","1 hour"); st.options[2].textContent=t("settings.session_timeout_1440","1 day"); st.options[3].textContent=t("settings.session_timeout_never","Never");
      document.getElementById("saveGeneralBtn").textContent = t("common.save", "Save");
      document.getElementById("profileTitle").textContent = t("settings.profile", "Profile");
      document.getElementById("labelProfileEmail").textContent = t("settings.profile_email", "Email");
      document.getElementById("labelProfileName").textContent = t("settings.profile_name", "Display name");
      document.getElementById("saveProfileBtn").textContent = t("settings.save_profile", "Save Profile");
      document.getElementById("labelCurrentPassword").textContent = t("settings.current_password", "Current password");
      document.getElementById("labelNewPassword").textContent = t("settings.new_password", "New password");
      document.getElementById("changePasswordBtn").textContent = t("settings.change_password", "Change Password");
      document.getElementById("backupTitle").textContent = t("settings.backup", "Backup");
      document.getElementById("labelAuto").textContent = t("settings.auto_enable", "Enable automatic backups");
      document.getElementById("labelInterval").textContent = t("settings.backup_interval", "Backup interval (minutes)");
      document.getElementById("labelRetention").textContent = t("settings.backup_retention", "Retention (days)");
      document.getElementById("saveBackupBtn").textContent = t("settings.save_backup", "Save Backup Settings");
      document.getElementById("downloadBtn").textContent = t("settings.download_backup", "Download Backup");
      document.getElementById("runNowBtn").textContent = t("settings.run_backup_now", "Run Backup Now");
      document.getElementById("restoreBtn").textContent = t("settings.restore_file", "Restore From File");
      document.getElementById("translationsTitle").textContent = t("settings.translations", "Translations");
      document.getElementById("labelLocale").textContent = t("settings.locale", "Locale");
      document.getElementById("saveTranslationsBtn").textContent = t("settings.save_custom", "Save Custom");
      document.getElementById("publishTranslationsBtn").textContent = t("settings.publish_file", "Publish To File");
      document.getElementById("accountTitle").textContent = t("settings.account", "Account");
      document.getElementById("accountDeleteInfo").textContent = t("settings.delete_account_info", "Deleting account removes all your data. You can create backup first.");
      document.getElementById("deleteAccountBtn").textContent = t("settings.delete_account", "Delete Account");
      const localeSel = document.getElementById("locale");
      localeSel.innerHTML = `<option value="en">English</option><option value="cs">Čeština</option>`;
    }

    function setMsg(text, isError=false){ MFUI.setMsg(text, isError); }

    async function loadUserProfile(){ const p=await MFUI.api("/api/v1/users/me"); document.getElementById("profileEmail").value=p.email||""; document.getElementById("profileName").value=p.fullName||""; }
    async function loadLocales(){ const data=await MFUI.api("/api/v1/i18n/locales"); const sel=document.getElementById("translationLocale"); sel.innerHTML=""; data.locales.forEach((loc)=>{ const o=document.createElement("option"); o.value=loc; o.textContent=loc; sel.appendChild(o); }); await loadLocaleJson(); }
    async function loadLocaleJson(){ const locale=document.getElementById("translationLocale").value; const data=await MFUI.api(`/api/v1/i18n/${locale}`); document.getElementById("translationJson").value=JSON.stringify(data.messages,null,2); }

    async function loadSettings(){
      const data = await MFUI.api("/api/v1/settings/app");
      if(data.defaultLocale) localStorage.setItem("mf_lang", data.defaultLocale);
      document.getElementById("locale").value = data.defaultLocale || "en";
      document.getElementById("provider").value = data.calendarProvider || "google";
      document.getElementById("syncEnabled").checked = !!data.calendarSyncEnabled;
      document.getElementById("registrationEnabled").checked = !!data.selfRegistrationEnabled;
      document.getElementById("smtpEnabled").checked = !!data.smtpEnabled;
      document.getElementById("autoBackupEnabled").checked = !!data.autoBackupEnabled;
      document.getElementById("backupInterval").value = data.autoBackupIntervalMinutes || 1440;
      document.getElementById("backupRetention").value = data.autoBackupRetentionDays || 30;
      document.getElementById("theme").value = localStorage.getItem("mf_theme") || "system";
      document.getElementById("layoutWidth").value = localStorage.getItem("mf_layout_width") || "full";
      document.getElementById("sessionTimeout").value = data.sessionTimeoutMinutes ? String(data.sessionTimeoutMinutes) : "never";
      fillTimezoneSelect(data.defaultTimezone || detectSystemTimezone());
    }

    async function saveGeneral(){
      const timeoutRaw = document.getElementById("sessionTimeout").value;
      const payload = {
        defaultLocale: document.getElementById("locale").value,
        defaultTimezone: document.getElementById("tz").value,
        calendarProvider: document.getElementById("provider").value,
        calendarSyncEnabled: document.getElementById("syncEnabled").checked,
        selfRegistrationEnabled: document.getElementById("registrationEnabled").checked,
        smtpEnabled: document.getElementById("smtpEnabled").checked,
        autoBackupEnabled: document.getElementById("autoBackupEnabled").checked,
        autoBackupIntervalMinutes: Number(document.getElementById("backupInterval").value || 1440),
        autoBackupRetentionDays: Number(document.getElementById("backupRetention").value || 30),
        sessionTimeoutMinutes: timeoutRaw === "never" ? null : Number(timeoutRaw),
      };
      await MFUI.api("/api/v1/settings/app", "PUT", payload);
      localStorage.setItem("mf_lang", payload.defaultLocale);
      localStorage.setItem("mf_layout_width", document.getElementById("layoutWidth").value || "full");
      MFUI.applyTheme();
      MFUI.applyLayout();
      await MFUI.init();
      applyTexts();
      setMsg(t("feedback.settings_saved", "Settings saved."));
    }

    async function saveProfile(){ await MFUI.api("/api/v1/users/me", "PUT", { email: document.getElementById("profileEmail").value.trim(), fullName: document.getElementById("profileName").value.trim() || null }); setMsg(t("settings.profile_saved", "Profile saved.")); await MFUI.init(); }
    async function changePassword(){ await MFUI.api("/api/v1/users/me/change-password", "POST", { currentPassword: document.getElementById("currentPassword").value, newPassword: document.getElementById("newPassword").value }); document.getElementById("currentPassword").value=""; document.getElementById("newPassword").value=""; setMsg(t("settings.password_saved", "Password updated.")); }
    async function downloadBackup(){ const res=await fetch("/api/v1/admin/backup/download",{credentials:"include"}); if(!res.ok) throw new Error(await res.text()); const blob=await res.blob(); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="my-finance-backup.json"; a.click(); URL.revokeObjectURL(url); setMsg(t("settings.backup_downloaded", "Backup downloaded.")); }
    async function runBackupNow(){ const d=await MFUI.api("/api/v1/admin/backup/run-now","POST"); setMsg(`${t("settings.backup_created", "Backup created: ")}${d.file}`); }
    async function restoreBackup(){ const f=document.getElementById("backupFile").files[0]; if(!f) throw new Error(t("settings.select_backup_file", "Select backup file.")); const fd=new FormData(); fd.append("file",f); await MFUI.api("/api/v1/admin/backup/import-file","POST",null,fd); setMsg(t("settings.restore_done", "Restore complete.")); }
    async function saveTranslations(){ const locale=document.getElementById("translationLocale").value; let payload={}; try{ payload=JSON.parse(document.getElementById("translationJson").value); }catch(_){ throw new Error(t("settings.invalid_json", "Invalid JSON.")); } await MFUI.api(`/api/v1/i18n/${locale}/custom`,"PUT",payload); setMsg(t("settings.translations_saved","Custom translation saved.")); await loadLocaleJson(); }
    async function publishTranslations(){ const locale=document.getElementById("translationLocale").value; const d=await MFUI.api(`/api/v1/i18n/${locale}/custom/publish`,"POST"); setMsg(`${t("settings.translations_published","Published to ")}${d.path}`); }
    async function deleteAccountFlow(){ if(confirm(t("settings.delete_account_ask_backup","Create backup before delete?"))) await downloadBackup(); if(!confirm(t("settings.delete_account_confirm","This action is permanent. Delete account now?"))) return; await MFUI.api("/api/v1/auth/me","DELETE"); window.location.href="/ui/get-started"; }

    function bind(){
      document.getElementById("saveGeneralBtn").addEventListener("click", ()=>saveGeneral().catch((e)=>setMsg(String(e.message||e), true)));
      document.getElementById("saveProfileBtn").addEventListener("click", ()=>saveProfile().catch((e)=>setMsg(String(e.message||e), true)));
      document.getElementById("changePasswordBtn").addEventListener("click", ()=>changePassword().catch((e)=>setMsg(String(e.message||e), true)));
      document.getElementById("saveBackupBtn").addEventListener("click", ()=>saveGeneral().catch((e)=>setMsg(String(e.message||e), true)));
      document.getElementById("downloadBtn").addEventListener("click", ()=>downloadBackup().catch((e)=>setMsg(String(e.message||e), true)));
      document.getElementById("runNowBtn").addEventListener("click", ()=>runBackupNow().catch((e)=>setMsg(String(e.message||e), true)));
      document.getElementById("restoreBtn").addEventListener("click", ()=>restoreBackup().catch((e)=>setMsg(String(e.message||e), true)));
      document.getElementById("saveTranslationsBtn").addEventListener("click", ()=>saveTranslations().catch((e)=>setMsg(String(e.message||e), true)));
      document.getElementById("publishTranslationsBtn").addEventListener("click", ()=>publishTranslations().catch((e)=>setMsg(String(e.message||e), true)));
      document.getElementById("translationLocale").addEventListener("change", ()=>loadLocaleJson().catch((e)=>setMsg(String(e.message||e), true)));
      document.getElementById("deleteAccountBtn").addEventListener("click", ()=>deleteAccountFlow().catch((e)=>setMsg(String(e.message||e), true)));
      document.getElementById("theme").addEventListener("change", (e)=>{ localStorage.setItem("mf_theme", e.target.value); MFUI.applyTheme(); setMsg(t("settings.theme_updated", "Theme updated.")); });
      document.getElementById("layoutWidth").addEventListener("change", (e)=>{ localStorage.setItem("mf_layout_width", e.target.value || "full"); MFUI.applyLayout(); setMsg(t("feedback.settings_saved", "Settings saved.")); });
      document.getElementById("detectTzBtn").addEventListener("click", ()=>{ const tz=detectSystemTimezone(); fillTimezoneSelect(tz); setMsg(`${t("onboarding.tz_detected","Timezone detected: ")}${tz}`); });
    }

    (async()=>{
      await MFUI.init();
      applyTexts();
      await loadSettings();
      await loadUserProfile();
      await loadLocales();
      bind();
    })().catch((e)=>setMsg(String(e.message||e), true));
  </script>
</body>
</html>


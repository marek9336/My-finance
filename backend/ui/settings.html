<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Finance - Settings</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#eef3f9; --surface:#fff; --text:#10243d; --primary:#0f6ecf; --border:#d8e2f0; --shadow:0 8px 24px rgba(16,36,61,.08); --err:#b3261e; --ok:#1b8f47; }
    body.dark { --bg:#0c1625; --surface:#13253a; --text:#e6f0ff; --primary:#5ea8ff; --border:#274565; --shadow:0 8px 24px rgba(0,0,0,.35); --err:#ff8a80; --ok:#6ed69b; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 24px; font-family: "Roboto", sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1120px; margin: 0 auto; display: grid; gap: 16px; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); padding: 20px; }
    .topbar { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .top-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .user-menu { position: relative; }
    .menu-btn { width: auto; margin: 0; background: transparent; border: 1px solid var(--border); color: var(--text); }
    .menu { position: absolute; right: 0; top: 42px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; min-width: 180px; box-shadow: var(--shadow); display: none; z-index: 30; }
    .menu.open { display: block; }
    .menu button { margin: 0; border-radius: 0; border: 0; border-bottom: 1px solid var(--border); background: transparent; color: var(--text); text-align: left; }
    .menu button:last-child { border-bottom: 0; color: var(--err); }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    input, select, textarea, button { border-radius: 10px; font-size: 14px; border: 1px solid var(--border); padding: 10px 12px; margin-bottom: 8px; }
    input, select, textarea { width: 100%; background:#fff; color:var(--text); }
    body.dark input, body.dark select, body.dark textarea { background:#0f1f33; color:#f0f6ff; border-color:#385c83; }
    body.dark select option { background:#0f1f33; color:#f0f6ff; }
    textarea { min-height: 220px; }
    button { background: var(--primary); color: #fff; border: 0; font-weight: 500; cursor: pointer; }
    button.secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .check { display:flex; align-items:center; gap:8px; margin-top:8px; }
    .check input { width: 18px; height: 18px; margin: 0; }
    .msg { font-size:14px; }
    .msg.ok { color:var(--ok); }
    .msg.err { color:var(--err); }
    .nav { color:var(--primary); text-decoration:none; font-weight:500; }
    .danger { border: 1px solid var(--err); }
    .danger button { background: var(--err); }
    .cookie { position: fixed; left: 16px; right: 16px; bottom: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); padding: 12px; display:none; z-index: 40; }
    .cookie-row { display:flex; gap:8px; flex-wrap:wrap; }
    .cookie-row button { width:auto; margin:0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="topbar">
        <div><h1 id="title">Settings</h1><p id="subtitle">Language, timezone, appearance, backup and translations.</p></div>
        <div class="top-actions">
          <a class="nav" href="/ui/dashboard" id="navDashboard">Dashboard</a>
          <a class="nav" href="/ui/settings" id="navSettings">Settings</a>
          <div class="user-menu"><button class="menu-btn" id="userBtn" type="button">...</button><div class="menu" id="userMenu"><button id="logoutBtn" type="button">Logout</button></div></div>
        </div>
      </div>
      <div id="msg" class="msg"></div>
    </div>

    <div class="card">
      <h2 id="generalTitle">General</h2>
      <div class="grid">
        <div><label id="labelLang" for="locale">Language</label><select id="locale"><option value="en">English</option><option value="cs">Čeština</option></select></div>
        <div><label id="labelProvider" for="provider">Calendar provider</label><select id="provider"><option value="google">google</option><option value="none">none</option></select></div>
        <div><label id="labelTz" for="tz">Timezone</label><select id="tz"></select><button class="secondary" id="detectTzBtn" type="button">Detect Timezone</button></div>
        <div><label id="labelTheme" for="theme">Appearance</label><select id="theme"><option value="system">System</option><option value="light">Light</option><option value="dark">Dark</option></select></div>
      </div>
      <div class="check"><input type="checkbox" id="syncEnabled"><label id="labelSync" for="syncEnabled">Calendar sync enabled</label></div>
      <div class="check"><input type="checkbox" id="registrationEnabled"><label id="labelReg" for="registrationEnabled">Self registration enabled</label></div>
      <div class="check"><input type="checkbox" id="smtpEnabled"><label id="labelSmtp" for="smtpEnabled">SMTP enabled</label></div>
      <div class="grid">
        <div>
          <label id="labelSessionTimeout" for="sessionTimeout">Auto logout</label>
          <select id="sessionTimeout">
            <option value="5">5 min</option>
            <option value="60">1 hour</option>
            <option value="1440">1 day</option>
            <option value="never">Never</option>
          </select>
        </div>
      </div>
      <button id="saveGeneralBtn" type="button">Save Settings</button>
    </div>

    <div class="card">
      <h2 id="backupTitle">Backup</h2>
      <div class="check"><input type="checkbox" id="autoBackupEnabled"><label id="labelAuto" for="autoBackupEnabled">Enable automatic backups</label></div>
      <div class="grid">
        <div><label id="labelInterval" for="backupInterval">Backup interval (minutes)</label><input id="backupInterval" type="number" min="5" step="1"></div>
        <div><label id="labelRetention" for="backupRetention">Retention (days)</label><input id="backupRetention" type="number" min="1" step="1"></div>
      </div>
      <div class="row">
        <button id="saveBackupBtn" type="button">Save Backup Settings</button>
        <button id="downloadBtn" type="button">Download Backup</button>
        <button id="runNowBtn" type="button">Run Backup Now</button>
      </div>
      <div class="row">
        <input id="backupFile" type="file" accept=".json,application/json" />
        <button id="restoreBtn" type="button">Restore From File</button>
      </div>
    </div>

    <div class="card">
      <h2 id="translationsTitle">Translations</h2>
      <div class="row">
        <label id="labelLocale" for="translationLocale">Locale</label>
        <select id="translationLocale" style="max-width:240px"></select>
      </div>
      <textarea id="translationJson">{}</textarea>
      <div class="row">
        <button id="saveTranslationsBtn" type="button">Save Custom</button>
        <button id="publishTranslationsBtn" type="button">Publish To File</button>
      </div>
    </div>

    <div class="card danger">
      <h2 id="accountTitle">Account</h2>
      <p id="accountDeleteInfo">Deleting account removes all your data. You can create backup first.</p>
      <button id="deleteAccountBtn" type="button">Delete Account</button>
    </div>
  </div>

  <div id="cookieBanner" class="cookie">
    <p id="cookieText">This app uses cookies for sign-in and secure session.</p>
    <div class="cookie-row">
      <button id="cookieNecessaryBtn" type="button" class="secondary">Only Necessary</button>
      <button id="cookieAcceptBtn" type="button">Accept</button>
    </div>
  </div>

  <script>
    const FALLBACK = {
      en: {
        title:"Settings", subtitle:"Language, timezone, appearance, backup and translations.", dashboard:"Dashboard", settings:"Settings", logout:"Logout", general:"General",
        lang:"Language", provider:"Calendar provider", timezone:"Timezone", appearance:"Appearance", detectTz:"Detect Timezone", sync:"Calendar sync enabled",
        reg:"Self registration enabled", smtp:"SMTP enabled", saveSettings:"Save Settings", backup:"Backup", autoEnable:"Enable automatic backups", interval:"Backup interval (minutes)",
        retention:"Retention (days)", saveBackup:"Save Backup Settings", download:"Download Backup", runNow:"Run Backup Now", restore:"Restore From File", translations:"Translations",
        locale:"Locale", saveCustom:"Save Custom", publish:"Publish To File", saved:"Settings saved.", themeUpdated:"Theme updated.", tzDetected:"Timezone detected: ",
        restoreDone:"Restore complete.", backupDownloaded:"Backup downloaded.", backupRun:"Backup created: ", translationsSaved:"Custom translation saved.", translationsPublished:"Published to ",
        selectBackup:"Select backup file.", invalidJson:"Invalid JSON.", authReq:"Authentication required.", sessionTimeout:"Auto logout", session5:"5 min", session60:"1 hour", session1440:"1 day", sessionNever:"Never",
        accountTitle:"Account", deleteInfo:"Deleting account removes all your data. You can create backup first.", deleteBtn:"Delete Account", deleteAskBackup:"Create backup before delete?",
        deleteConfirm:"This action is permanent. Delete account now?", deleteDone:"Account deleted.", cookieText:"This app uses cookies for sign-in and secure session.",
        cookieNecessary:"Only Necessary", cookieAccept:"Accept"
      },
      cs: {
        title:"Nastavení", subtitle:"Jazyk, časové pásmo, vzhled, záloha a překlady.", dashboard:"Přehled", settings:"Nastavení", logout:"Odhlásit", general:"Obecné",
        lang:"Jazyk", provider:"Poskytovatel kalendáře", timezone:"Časové pásmo", appearance:"Vzhled", detectTz:"Zjistit časové pásmo", sync:"Synchronizace kalendáře zapnuta",
        reg:"Samoobslužná registrace povolena", smtp:"SMTP zapnuto", saveSettings:"Uložit nastavení", backup:"Záloha", autoEnable:"Povolit automatické zálohy", interval:"Interval zálohy (minuty)",
        retention:"Retence (dny)", saveBackup:"Uložit nastavení záloh", download:"Stáhnout zálohu", runNow:"Spustit zálohu nyní", restore:"Obnovit ze souboru", translations:"Překlady",
        locale:"Jazyk", saveCustom:"Uložit vlastní", publish:"Publikovat do souboru", saved:"Nastavení uloženo.", themeUpdated:"Vzhled aktualizován.", tzDetected:"Detekované časové pásmo: ",
        restoreDone:"Obnova dokončena.", backupDownloaded:"Záloha stažena.", backupRun:"Záloha vytvořena: ", translationsSaved:"Vlastní překlad uložen.", translationsPublished:"Publikováno do ",
        selectBackup:"Vyber soubor se zálohou.", invalidJson:"Neplatný JSON.", authReq:"Je vyžadováno přihlášení.", sessionTimeout:"Automatické odhlášení", session5:"5 min", session60:"1 hodina", session1440:"1 den", sessionNever:"Nikdy",
        accountTitle:"Účet", deleteInfo:"Smazání účtu odstraní všechna data. Před smazáním můžeš vytvořit zálohu.", deleteBtn:"Smazat účet", deleteAskBackup:"Vytvořit před smazáním zálohu?",
        deleteConfirm:"Tato akce je nevratná. Opravdu smazat účet?", deleteDone:"Účet byl smazán.", cookieText:"Aplikace používá cookies pro přihlášení a bezpečnou relaci.",
        cookieNecessary:"Pouze nezbytné", cookieAccept:"Přijmout"
      }
    };
    let M = {};
    function lang() { return localStorage.getItem("mf_lang") || "en"; }
    function t(k) { return M[k] || FALLBACK[lang()][k] || k; }
    async function loadLocaleMessages(locale) {
      M = { ...FALLBACK[locale] };
      try {
        const res = await fetch(`/api/v1/i18n/${locale}`, { credentials: "include" });
        if (res.ok) {
          const data = await res.json();
          M = { ...M, ...(data.messages || {}) };
        }
      } catch (_) {}
    }
    function applyTheme() {
      const theme = localStorage.getItem("mf_theme") || "system";
      document.body.classList.remove("dark");
      if (theme === "dark" || (theme === "system" && window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches)) document.body.classList.add("dark");
    }
    function parseShortOffset(raw) {
      const m = raw.match(/GMT([+-])(\d{1,2})(?::(\d{2}))?/);
      if (!m) return 0;
      const sign = m[1] === "-" ? -1 : 1;
      return sign * (Number(m[2]) * 60 + Number(m[3] || 0));
    }
    function offsetForZone(zone) {
      try {
        const part = new Intl.DateTimeFormat("en-US", { timeZone: zone, timeZoneName: "shortOffset" })
          .formatToParts(new Date())
          .find((p) => p.type === "timeZoneName");
        return parseShortOffset(part ? part.value : "GMT+0");
      } catch (_) { return 0; }
    }
    function offsetText(minutes) {
      const sign = minutes < 0 ? "-" : "+";
      const abs = Math.abs(minutes);
      const h = String(Math.floor(abs / 60)).padStart(2, "0");
      const m = String(abs % 60).padStart(2, "0");
      return `UTC${sign}${h}:${m}`;
    }
    function timezoneRows() {
      let zones = ["UTC", "Europe/Prague"];
      if (typeof Intl !== "undefined" && typeof Intl.supportedValuesOf === "function") {
        try { zones = Intl.supportedValuesOf("timeZone"); } catch (_) {}
      }
      return zones.map((z) => ({ value: z, offset: offsetForZone(z) })).sort((a, b) => (a.offset - b.offset) || a.value.localeCompare(b.value));
    }
    function detectSystemTimezone() {
      try { return Intl.DateTimeFormat().resolvedOptions().timeZone || "Europe/Prague"; } catch (_) { return "Europe/Prague"; }
    }
    function fillTimezoneSelect(selected) {
      const sel = document.getElementById("tz");
      sel.innerHTML = "";
      timezoneRows().forEach((z) => {
        const o = document.createElement("option");
        o.value = z.value;
        o.textContent = `(${offsetText(z.offset)}) ${z.value.replaceAll("_", " ")}`;
        sel.appendChild(o);
      });
      if (![...sel.options].some((o) => o.value === selected)) {
        const o = document.createElement("option");
        o.value = selected;
        o.textContent = selected;
        sel.appendChild(o);
      }
      sel.value = selected;
    }
    function applyTexts() {
      document.documentElement.lang = lang();
      document.getElementById("title").textContent = t("title");
      document.getElementById("subtitle").textContent = t("subtitle");
      document.getElementById("navDashboard").textContent = t("dashboard");
      document.getElementById("navSettings").textContent = t("settings");
      document.getElementById("logoutBtn").textContent = t("logout");
      document.getElementById("generalTitle").textContent = t("general");
      document.getElementById("labelLang").textContent = t("lang");
      document.getElementById("labelProvider").textContent = t("provider");
      document.getElementById("labelTz").textContent = t("timezone");
      document.getElementById("labelTheme").textContent = t("appearance");
      document.getElementById("detectTzBtn").textContent = t("detectTz");
      document.getElementById("labelSync").textContent = t("sync");
      document.getElementById("labelReg").textContent = t("reg");
      document.getElementById("labelSmtp").textContent = t("smtp");
      document.getElementById("labelSessionTimeout").textContent = t("sessionTimeout");
      document.getElementById("sessionTimeout").options[0].textContent = t("session5");
      document.getElementById("sessionTimeout").options[1].textContent = t("session60");
      document.getElementById("sessionTimeout").options[2].textContent = t("session1440");
      document.getElementById("sessionTimeout").options[3].textContent = t("sessionNever");
      document.getElementById("saveGeneralBtn").textContent = t("saveSettings");
      document.getElementById("backupTitle").textContent = t("backup");
      document.getElementById("labelAuto").textContent = t("autoEnable");
      document.getElementById("labelInterval").textContent = t("interval");
      document.getElementById("labelRetention").textContent = t("retention");
      document.getElementById("saveBackupBtn").textContent = t("saveBackup");
      document.getElementById("downloadBtn").textContent = t("download");
      document.getElementById("runNowBtn").textContent = t("runNow");
      document.getElementById("restoreBtn").textContent = t("restore");
      document.getElementById("translationsTitle").textContent = t("translations");
      document.getElementById("labelLocale").textContent = t("locale");
      document.getElementById("saveTranslationsBtn").textContent = t("saveCustom");
      document.getElementById("publishTranslationsBtn").textContent = t("publish");
      document.getElementById("accountTitle").textContent = t("accountTitle");
      document.getElementById("accountDeleteInfo").textContent = t("deleteInfo");
      document.getElementById("deleteAccountBtn").textContent = t("deleteBtn");
      document.getElementById("cookieText").textContent = t("cookieText");
      document.getElementById("cookieNecessaryBtn").textContent = t("cookieNecessary");
      document.getElementById("cookieAcceptBtn").textContent = t("cookieAccept");
      fillTimezoneSelect(document.getElementById("tz").value || "Europe/Prague");
    }
    function showCookieBannerIfNeeded() {
      document.getElementById("cookieBanner").style.display = localStorage.getItem("mf_cookie_consent") ? "none" : "block";
    }
    function setMsg(text, isError = false) {
      const m = document.getElementById("msg");
      m.textContent = text;
      m.className = `msg ${isError ? "err" : "ok"}`;
    }
    function mapError(msg) {
      const m = (msg || "").toLowerCase();
      if (m.includes("authentication required")) return t("authReq");
      return msg;
    }
    async function parseError(res) {
      try {
        const d = await res.json();
        if (d && d.error && d.error.details && d.error.details.length) return d.error.details.map((x) => `${x.field}: ${x.message}`).join("; ");
        if (d && d.detail) return mapError(d.detail);
      } catch (_) {}
      return `HTTP ${res.status}`;
    }
    async function api(path, method = "GET", body = null, formData = null) {
      const init = { method, credentials: "include" };
      if (formData) init.body = formData;
      else { init.headers = { "Content-Type": "application/json" }; init.body = body ? JSON.stringify(body) : null; }
      const res = await fetch(path, init);
      if (!res.ok) throw new Error(await parseError(res));
      if (res.headers.get("content-type") && res.headers.get("content-type").includes("application/json")) return await res.json();
      return res;
    }
    async function loadUser() {
      const me = await api("/api/v1/auth/me");
      document.getElementById("userBtn").textContent = me.fullName ? `${me.fullName} (${me.email})` : me.email;
    }
    async function loadSettings() {
      const data = await api("/api/v1/settings/app");
      if (data.defaultLocale) localStorage.setItem("mf_lang", data.defaultLocale);
      await loadLocaleMessages(localStorage.getItem("mf_lang") || "en");
      document.getElementById("locale").value = data.defaultLocale || lang();
      document.getElementById("provider").value = data.calendarProvider;
      document.getElementById("syncEnabled").checked = data.calendarSyncEnabled;
      document.getElementById("registrationEnabled").checked = data.selfRegistrationEnabled;
      document.getElementById("smtpEnabled").checked = data.smtpEnabled;
      document.getElementById("autoBackupEnabled").checked = data.autoBackupEnabled;
      document.getElementById("backupInterval").value = data.autoBackupIntervalMinutes;
      document.getElementById("backupRetention").value = data.autoBackupRetentionDays;
      document.getElementById("theme").value = localStorage.getItem("mf_theme") || "system";
      document.getElementById("sessionTimeout").value = data.sessionTimeoutMinutes ? String(data.sessionTimeoutMinutes) : "never";
      fillTimezoneSelect(data.defaultTimezone || detectSystemTimezone());
      applyTheme();
      applyTexts();
      await loadLocales();
    }
    async function saveGeneral() {
      const timeoutRaw = document.getElementById("sessionTimeout").value;
      const payload = {
        defaultLocale: document.getElementById("locale").value,
        defaultTimezone: document.getElementById("tz").value,
        calendarProvider: document.getElementById("provider").value,
        calendarSyncEnabled: document.getElementById("syncEnabled").checked,
        selfRegistrationEnabled: document.getElementById("registrationEnabled").checked,
        smtpEnabled: document.getElementById("smtpEnabled").checked,
        autoBackupEnabled: document.getElementById("autoBackupEnabled").checked,
        autoBackupIntervalMinutes: Number(document.getElementById("backupInterval").value || 1440),
        autoBackupRetentionDays: Number(document.getElementById("backupRetention").value || 30),
        sessionTimeoutMinutes: timeoutRaw === "never" ? null : Number(timeoutRaw)
      };
      await api("/api/v1/settings/app", "PUT", payload);
      localStorage.setItem("mf_lang", payload.defaultLocale);
      await loadLocaleMessages(payload.defaultLocale);
      applyTexts();
      setMsg(t("saved"));
    }
    async function saveBackup() { await saveGeneral(); }
    async function downloadBackup() {
      const res = await fetch("/api/v1/admin/backup/download", { credentials: "include" });
      if (!res.ok) throw new Error(await parseError(res));
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "my-finance-backup.json";
      a.click();
      URL.revokeObjectURL(url);
      setMsg(t("backupDownloaded"));
    }
    async function runBackupNow() {
      const d = await api("/api/v1/admin/backup/run-now", "POST");
      setMsg(`${t("backupRun")}${d.file}`);
    }
    async function restoreBackup() {
      const f = document.getElementById("backupFile").files[0];
      if (!f) throw new Error(t("selectBackup"));
      const fd = new FormData();
      fd.append("file", f);
      await api("/api/v1/admin/backup/import-file", "POST", null, fd);
      setMsg(t("restoreDone"));
    }
    async function loadLocales() {
      const data = await api("/api/v1/i18n/locales");
      const sel = document.getElementById("translationLocale");
      sel.innerHTML = "";
      data.locales.forEach((loc) => {
        const o = document.createElement("option");
        o.value = loc;
        o.textContent = loc;
        sel.appendChild(o);
      });
      const preferred = document.getElementById("locale").value || lang();
      if ([...sel.options].some((o) => o.value === preferred)) sel.value = preferred;
      await loadLocale();
    }
    async function loadLocale() {
      const locale = document.getElementById("translationLocale").value;
      const data = await api(`/api/v1/i18n/${locale}`);
      document.getElementById("translationJson").value = JSON.stringify(data.messages, null, 2);
    }
    async function saveTranslations() {
      const locale = document.getElementById("translationLocale").value;
      let payload = {};
      try { payload = JSON.parse(document.getElementById("translationJson").value); } catch (_) { throw new Error(t("invalidJson")); }
      await api(`/api/v1/i18n/${locale}/custom`, "PUT", payload);
      setMsg(t("translationsSaved"));
      if (locale === lang()) {
        await loadLocaleMessages(locale);
        applyTexts();
      }
      await loadLocale();
    }
    async function publishTranslations() {
      const locale = document.getElementById("translationLocale").value;
      const d = await api(`/api/v1/i18n/${locale}/custom/publish`, "POST");
      setMsg(`${t("translationsPublished")}${d.path}`);
    }
    async function deleteAccountFlow() {
      if (confirm(t("deleteAskBackup"))) await downloadBackup();
      if (!confirm(t("deleteConfirm"))) return;
      await api("/api/v1/auth/me", "DELETE");
      setMsg(t("deleteDone"));
      window.location.href = "/ui/get-started";
    }
    async function logout() {
      await api("/api/v1/auth/logout", "POST");
      window.location.href = "/ui/get-started";
    }
    async function safe(fn) { try { await fn(); } catch (e) { setMsg(mapError(e.message), true); } }

    const menu = document.getElementById("userMenu");
    document.getElementById("userBtn").addEventListener("click", () => menu.classList.toggle("open"));
    document.addEventListener("click", (e) => { if (!e.target.closest(".user-menu")) menu.classList.remove("open"); });
    document.getElementById("logoutBtn").addEventListener("click", () => safe(logout));
    document.getElementById("detectTzBtn").addEventListener("click", () => { const tz = detectSystemTimezone(); fillTimezoneSelect(tz); setMsg(`${t("tzDetected")}${tz}`); });
    document.getElementById("theme").addEventListener("change", (e) => { localStorage.setItem("mf_theme", e.target.value); applyTheme(); setMsg(t("themeUpdated")); });
    document.getElementById("locale").addEventListener("change", async (e) => { localStorage.setItem("mf_lang", e.target.value); await loadLocaleMessages(e.target.value); applyTexts(); });
    document.getElementById("saveGeneralBtn").addEventListener("click", () => safe(saveGeneral));
    document.getElementById("saveBackupBtn").addEventListener("click", () => safe(saveBackup));
    document.getElementById("downloadBtn").addEventListener("click", () => safe(downloadBackup));
    document.getElementById("runNowBtn").addEventListener("click", () => safe(runBackupNow));
    document.getElementById("restoreBtn").addEventListener("click", () => safe(restoreBackup));
    document.getElementById("translationLocale").addEventListener("change", () => safe(loadLocale));
    document.getElementById("saveTranslationsBtn").addEventListener("click", () => safe(saveTranslations));
    document.getElementById("publishTranslationsBtn").addEventListener("click", () => safe(publishTranslations));
    document.getElementById("deleteAccountBtn").addEventListener("click", () => safe(deleteAccountFlow));
    document.getElementById("cookieNecessaryBtn").addEventListener("click", () => { localStorage.setItem("mf_cookie_consent", "necessary"); showCookieBannerIfNeeded(); });
    document.getElementById("cookieAcceptBtn").addEventListener("click", () => { localStorage.setItem("mf_cookie_consent", "all"); showCookieBannerIfNeeded(); });

    (async () => {
      applyTheme();
      await loadLocaleMessages(lang());
      applyTexts();
      await safe(loadUser);
      await safe(loadSettings);
      showCookieBannerIfNeeded();
    })();
  </script>
</body>
</html>

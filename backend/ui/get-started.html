<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Finance - Get Started</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#eef3f9; --surface:#fff; --text:#10243d; --primary:#0f6ecf; --border:#d8e2f0; --shadow:0 8px 24px rgba(16,36,61,.08); --err:#b3261e; --ok:#1b8f47; }
    body.dark { --bg:#0c1625; --surface:#13253a; --text:#e6f0ff; --primary:#5ea8ff; --border:#274565; --shadow:0 8px 24px rgba(0,0,0,.35); --err:#ff8a80; --ok:#6ed69b; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 24px; font-family: "Roboto", sans-serif; background: linear-gradient(140deg, var(--bg), #f7fbff); color: var(--text); }
    .container { max-width: 1100px; margin: 0 auto; display: grid; gap: 16px; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); padding: 20px; }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
    .box { border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
    input, select, button { width: 100%; border-radius: 10px; font-size: 14px; border: 1px solid var(--border); padding: 10px 12px; margin-bottom: 8px; }
    input, select { background: #fff; color: var(--text); }
    body.dark input, body.dark select { background:#0f1f33; color:#f0f6ff; border-color:#385c83; }
    body.dark select option { background:#0f1f33; color:#f0f6ff; }
    button { background: var(--primary); color: #fff; border: 0; font-weight: 500; cursor: pointer; }
    button.secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .msg { font-size: 14px; }
    .msg.ok { color: var(--ok); }
    .msg.err { color: var(--err); }
    .check { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .check input { width:16px; height:16px; margin:0; }
    #loggedInPanel { display:none; }
    .cookie { position: fixed; left: 16px; right: 16px; bottom: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); padding: 12px; display:none; z-index: 40; }
    .cookie-row { display:flex; gap:8px; flex-wrap:wrap; }
    .cookie-row button { width:auto; margin:0; }
    .auth-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .auth-actions button { width:auto; margin:0; }
    dialog.auth-dialog {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--surface);
      color: var(--text);
      width: min(460px, 95vw);
      box-shadow: var(--shadow);
      padding: 0;
    }
    dialog.auth-dialog::backdrop { background: rgba(0,0,0,.45); }
    .dialog-content { padding: 16px; }
    .dialog-actions { display:flex; gap:8px; justify-content:flex-end; }
    .dialog-actions button { width:auto; margin:0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1 id="title">Get Started</h1>
      <p id="subtitle">Choose app language, timezone, appearance and create your account.</p>
      <div id="msg" class="msg"></div>
      <div id="loggedInPanel" class="box">
        <p id="alreadyLoggedInText">You are already signed in.</p>
        <div class="row">
          <button id="goDashboardBtn" type="button">Open Dashboard</button>
          <button id="logoutFirstBtn" type="button" class="secondary">Logout First</button>
        </div>
      </div>
    </div>

    <div class="card row">
      <div class="box">
        <h3 id="setupTitle">Initial Setup</h3>
        <label for="lang" id="langLabel">Language</label>
        <select id="lang"><option value="en">English</option><option value="cs">Čeština</option></select>
        <label for="tz" id="tzLabel">Timezone</label>
        <select id="tz"></select>
        <button id="detectTzBtn" class="secondary" type="button">Detect Timezone</button>
        <label for="theme" id="themeLabel">Appearance</label>
        <select id="theme"><option value="system">System</option><option value="light">Light</option><option value="dark">Dark</option></select>
      </div>
      <div class="box">
        <h3 id="restoreTitle">Restore Database</h3>
        <input id="restoreFile" type="file" accept=".json,application/json" />
        <button id="restoreBtn" type="button">Restore Backup JSON</button>
      </div>
    </div>

    <div id="authRow" class="card">
      <h3 id="authTitle">Sign In or Register</h3>
      <div class="auth-actions">
        <button id="openLoginBtn" type="button">Login</button>
        <button id="openRegisterBtn" type="button" class="secondary">Register</button>
      </div>
    </div>
  </div>

  <dialog id="loginDialog" class="auth-dialog">
    <div class="dialog-content">
      <h3 id="loginTitle">Login</h3>
      <form id="loginForm" autocomplete="on">
        <input id="loginEmail" name="username" type="email" autocomplete="username" placeholder="email@example.com" />
        <input id="loginPassword" name="password" type="password" autocomplete="current-password" placeholder="Password" />
        <label class="check"><input id="rememberMe" type="checkbox"><span id="rememberLabel">Stay signed in</span></label>
        <div class="dialog-actions">
          <button id="loginCancelBtn" type="button" class="secondary">Cancel</button>
          <button id="loginBtn" type="submit">Login</button>
        </div>
      </form>
    </div>
  </dialog>

  <dialog id="registerDialog" class="auth-dialog">
    <div class="dialog-content">
      <h3 id="registerTitle">Register</h3>
      <form id="registerForm" autocomplete="on">
        <input id="regEmail" name="email" type="email" autocomplete="email" placeholder="email@example.com" />
        <input id="regName" name="name" autocomplete="name" placeholder="Full name (optional)" />
        <input id="regPassword" name="new-password" type="password" autocomplete="new-password" placeholder="Password (min 8)" />
        <div class="dialog-actions">
          <button id="registerCancelBtn" type="button" class="secondary">Cancel</button>
          <button id="regBtn" type="submit">Register</button>
        </div>
      </form>
    </div>
  </dialog>

  <div id="cookieBanner" class="cookie">
    <p id="cookieText">This app uses cookies for sign-in and secure session.</p>
    <div class="cookie-row">
      <button id="cookieNecessaryBtn" type="button" class="secondary">Only Necessary</button>
      <button id="cookieAcceptBtn" type="button">Accept</button>
    </div>
  </div>

  <script>
    const FALLBACK = {
      en: {
        title: "Get Started", subtitle: "Choose app language, timezone, appearance and create your account.",
        setupTitle: "Initial Setup", restoreTitle: "Restore Database", registerTitle: "Register", loginTitle: "Login", authTitle: "Sign In or Register",
        langLabel: "Language", tzLabel: "Timezone", themeLabel: "Appearance", detectTz: "Detect Timezone",
        restoreBtn: "Restore Backup JSON", regBtn: "Register", loginBtn: "Login", rememberLabel: "Stay signed in",
        openLoginBtn: "Login", openRegisterBtn: "Register", cancelBtn: "Cancel",
        regEmailPh: "email@example.com", regNamePh: "Full name (optional)", regPassPh: "Password (min 8)", loginEmailPh: "email@example.com", loginPassPh: "Password",
        errFill: "Fill email and password.", errSelect: "Select backup file.", errPwd: "Password must have at least 8 characters.", errEmail: "Invalid email format.",
        tzDetected: "Timezone detected: ", restoreDone: "Restore completed. Accounts: ", alreadyLoggedIn: "You are already signed in.",
        goDashboard: "Open Dashboard", logoutFirst: "Logout First", authReq: "Authentication required.", cookieText: "This app uses cookies for sign-in and secure session.",
        cookieNecessary: "Only Necessary", cookieAccept: "Accept", cookieRequired: "You need to accept necessary cookies before sign-in."
      },
      cs: {
        title: "Začínáme", subtitle: "Nastav jazyk, časové pásmo, vzhled a vytvoř účet.",
        setupTitle: "První nastavení", restoreTitle: "Obnovit databázi", registerTitle: "Registrace", loginTitle: "Přihlášení", authTitle: "Přihlášení nebo registrace",
        langLabel: "Jazyk", tzLabel: "Časové pásmo", themeLabel: "Vzhled", detectTz: "Zjistit časové pásmo",
        restoreBtn: "Obnovit zálohu JSON", regBtn: "Registrovat", loginBtn: "Přihlásit", rememberLabel: "Zůstat přihlášen",
        openLoginBtn: "Přihlášení", openRegisterBtn: "Registrace", cancelBtn: "Zrušit",
        regEmailPh: "email@example.com", regNamePh: "Celé jméno (volitelné)", regPassPh: "Heslo (min. 8 znaků)", loginEmailPh: "email@example.com", loginPassPh: "Heslo",
        errFill: "Vyplň e-mail a heslo.", errSelect: "Vyber soubor se zálohou.", errPwd: "Heslo musí mít alespoň 8 znaků.", errEmail: "Neplatný formát e-mailu.",
        tzDetected: "Detekované časové pásmo: ", restoreDone: "Obnova dokončena. Účty: ", alreadyLoggedIn: "Už jsi přihlášen.",
        goDashboard: "Otevřít přehled", logoutFirst: "Nejdříve odhlásit", authReq: "Je vyžadováno přihlášení.", cookieText: "Aplikace používá cookies pro přihlášení a bezpečnou relaci.",
        cookieNecessary: "Pouze nezbytné", cookieAccept: "Přijmout", cookieRequired: "Pro přihlášení je potřeba povolit nezbytné cookies."
      }
    };
    let M = {};

    function currentLang() { return localStorage.getItem("mf_lang") || "en"; }
    function t(key) { return M[key] || FALLBACK[currentLang()][key] || key; }
    async function loadLocale(lang) {
      M = { ...FALLBACK[lang] };
      try {
        const res = await fetch(`/api/v1/public/i18n/${lang}`, { credentials: "include" });
        if (res.ok) {
          const data = await res.json();
          M = { ...M, ...(data.messages || {}) };
        }
      } catch (_) {}
    }
    function applyTheme(theme) {
      document.body.classList.remove("dark");
      if (theme === "dark" || (theme === "system" && window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches)) document.body.classList.add("dark");
    }
    function setMsg(text, isError = false) {
      const m = document.getElementById("msg");
      m.textContent = text;
      m.className = `msg ${isError ? "err" : "ok"}`;
    }
    function parseShortOffset(raw) {
      const m = raw.match(/GMT([+-])(\d{1,2})(?::(\d{2}))?/);
      if (!m) return 0;
      const sign = m[1] === "-" ? -1 : 1;
      const h = Number(m[2] || 0);
      const mm = Number(m[3] || 0);
      return sign * (h * 60 + mm);
    }
    function offsetForZone(zone) {
      try {
        const part = new Intl.DateTimeFormat("en-US", { timeZone: zone, timeZoneName: "shortOffset" })
          .formatToParts(new Date())
          .find((p) => p.type === "timeZoneName");
        return parseShortOffset(part ? part.value : "GMT+0");
      } catch (_) {
        return 0;
      }
    }
    function offsetText(minutes) {
      const sign = minutes < 0 ? "-" : "+";
      const abs = Math.abs(minutes);
      const h = String(Math.floor(abs / 60)).padStart(2, "0");
      const m = String(abs % 60).padStart(2, "0");
      return `UTC${sign}${h}:${m}`;
    }
    function timezonesSorted() {
      let zones = ["UTC", "Europe/Prague"];
      if (typeof Intl !== "undefined" && typeof Intl.supportedValuesOf === "function") {
        try { zones = Intl.supportedValuesOf("timeZone"); } catch (_) {}
      }
      return zones
        .map((z) => ({ value: z, offset: offsetForZone(z) }))
        .sort((a, b) => (a.offset - b.offset) || a.value.localeCompare(b.value));
    }
    function detectTz() {
      try { return Intl.DateTimeFormat().resolvedOptions().timeZone || "Europe/Prague"; } catch (_) { return "Europe/Prague"; }
    }
    function fillTz(selected) {
      const s = document.getElementById("tz");
      s.innerHTML = "";
      const rows = timezonesSorted();
      rows.forEach((row) => {
        const o = document.createElement("option");
        o.value = row.value;
        o.textContent = `(${offsetText(row.offset)}) ${row.value.replaceAll("_", " ")}`;
        s.appendChild(o);
      });
      if (![...s.options].some((x) => x.value === selected)) {
        const o = document.createElement("option");
        o.value = selected;
        o.textContent = selected;
        s.appendChild(o);
      }
      s.value = selected;
    }
    function applyTexts() {
      document.documentElement.lang = currentLang();
      document.getElementById("title").textContent = t("title");
      document.getElementById("subtitle").textContent = t("subtitle");
      document.getElementById("setupTitle").textContent = t("setupTitle");
      document.getElementById("restoreTitle").textContent = t("restoreTitle");
      document.getElementById("registerTitle").textContent = t("registerTitle");
      document.getElementById("loginTitle").textContent = t("loginTitle");
      document.getElementById("authTitle").textContent = t("authTitle");
      document.getElementById("langLabel").textContent = t("langLabel");
      document.getElementById("tzLabel").textContent = t("tzLabel");
      document.getElementById("themeLabel").textContent = t("themeLabel");
      document.getElementById("detectTzBtn").textContent = t("detectTz");
      document.getElementById("restoreBtn").textContent = t("restoreBtn");
      document.getElementById("regBtn").textContent = t("regBtn");
      document.getElementById("loginBtn").textContent = t("loginBtn");
      document.getElementById("openLoginBtn").textContent = t("openLoginBtn");
      document.getElementById("openRegisterBtn").textContent = t("openRegisterBtn");
      document.getElementById("loginCancelBtn").textContent = t("cancelBtn");
      document.getElementById("registerCancelBtn").textContent = t("cancelBtn");
      document.getElementById("rememberLabel").textContent = t("rememberLabel");
      document.getElementById("regEmail").placeholder = t("regEmailPh");
      document.getElementById("regName").placeholder = t("regNamePh");
      document.getElementById("regPassword").placeholder = t("regPassPh");
      document.getElementById("loginEmail").placeholder = t("loginEmailPh");
      document.getElementById("loginPassword").placeholder = t("loginPassPh");
      document.getElementById("alreadyLoggedInText").textContent = t("alreadyLoggedIn");
      document.getElementById("goDashboardBtn").textContent = t("goDashboard");
      document.getElementById("logoutFirstBtn").textContent = t("logoutFirst");
      document.getElementById("cookieText").textContent = t("cookieText");
      document.getElementById("cookieNecessaryBtn").textContent = t("cookieNecessary");
      document.getElementById("cookieAcceptBtn").textContent = t("cookieAccept");
    }
    function hasCookieConsent() { return !!localStorage.getItem("mf_cookie_consent"); }
    function showCookieBannerIfNeeded() {
      document.getElementById("cookieBanner").style.display = hasCookieConsent() ? "none" : "block";
    }
    function mapError(msg) {
      const m = (msg || "").toLowerCase();
      if (m.includes("string should have at least 8 characters") || m.includes("at least 8")) return t("errPwd");
      if (m.includes("invalid email")) return t("errEmail");
      if (m.includes("authentication required")) return t("authReq");
      return msg;
    }
    async function parseError(res) {
      try {
        const d = await res.json();
        if (d && d.error && d.error.details && d.error.details.length) return mapError(d.error.details.map((x) => `${x.field}: ${x.message}`).join("; "));
        if (d && d.detail) return mapError(d.detail);
      } catch (_) {}
      return `HTTP ${res.status}`;
    }
    async function api(path, method = "GET", body = null, formData = null) {
      const init = { method, credentials: "include" };
      if (formData) init.body = formData;
      else { init.headers = { "Content-Type": "application/json" }; init.body = body ? JSON.stringify(body) : null; }
      const res = await fetch(path, init);
      if (!res.ok) throw new Error(await parseError(res));
      if (res.status === 204) return null;
      if (res.headers.get("content-type") && res.headers.get("content-type").includes("application/json")) return await res.json();
      return null;
    }
    async function saveSettingsIfLoggedIn() {
      try {
        await api("/api/v1/settings/app", "PUT", { defaultLocale: document.getElementById("lang").value, defaultTimezone: document.getElementById("tz").value });
      } catch (_) {}
    }
    async function checkLoggedInState() {
      try {
        const me = await api("/api/v1/auth/me");
        if (!me || !me.email) return;
        document.getElementById("loggedInPanel").style.display = "block";
        document.getElementById("authRow").style.display = "none";
      } catch (_) {
        document.getElementById("loggedInPanel").style.display = "none";
        document.getElementById("authRow").style.display = "block";
      }
    }
    async function register() {
      if (!hasCookieConsent()) throw new Error(t("cookieRequired"));
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value;
      if (!email || !password) throw new Error(t("errFill"));
      await api("/api/v1/auth/register", "POST", { email, fullName: document.getElementById("regName").value || null, password });
      await saveSettingsIfLoggedIn();
      window.location.href = "/ui/dashboard";
    }
    async function login() {
      if (!hasCookieConsent()) throw new Error(t("cookieRequired"));
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      if (!email || !password) throw new Error(t("errFill"));
      await api("/api/v1/auth/login", "POST", { email, password, rememberMe: document.getElementById("rememberMe").checked });
      await saveSettingsIfLoggedIn();
      window.location.href = "/ui/dashboard";
    }
    async function restore() {
      const f = document.getElementById("restoreFile").files[0];
      if (!f) throw new Error(t("errSelect"));
      const fd = new FormData();
      fd.append("file", f);
      const data = await api("/api/v1/bootstrap/restore", "POST", null, fd);
      setMsg(`${t("restoreDone")}${data && data.counts ? (data.counts.accounts || 0) : 0}`);
    }
    async function logout() {
      await api("/api/v1/auth/logout", "POST");
      document.getElementById("loggedInPanel").style.display = "none";
      document.getElementById("authRow").style.display = "block";
      setMsg("");
    }
    async function safe(fn) { try { await fn(); } catch (e) { setMsg(mapError(e.message), true); } }
    async function init() {
      const savedLang = currentLang();
      const savedTheme = localStorage.getItem("mf_theme") || "system";
      document.getElementById("lang").value = savedLang;
      document.getElementById("theme").value = savedTheme;
      fillTz(detectTz());
      await loadLocale(savedLang);
      applyTexts();
      applyTheme(savedTheme);
      await checkLoggedInState();
      showCookieBannerIfNeeded();
    }

    document.getElementById("lang").addEventListener("change", async (e) => {
      localStorage.setItem("mf_lang", e.target.value);
      await loadLocale(e.target.value);
      applyTexts();
      fillTz(document.getElementById("tz").value || detectTz());
    });
    document.getElementById("theme").addEventListener("change", (e) => { localStorage.setItem("mf_theme", e.target.value); applyTheme(e.target.value); });
    document.getElementById("detectTzBtn").addEventListener("click", () => { const tz = detectTz(); fillTz(tz); setMsg(`${t("tzDetected")}${tz}`); });
    document.getElementById("restoreBtn").addEventListener("click", () => safe(restore));
    document.getElementById("openLoginBtn").addEventListener("click", () => document.getElementById("loginDialog").showModal());
    document.getElementById("openRegisterBtn").addEventListener("click", () => document.getElementById("registerDialog").showModal());
    document.getElementById("loginCancelBtn").addEventListener("click", () => document.getElementById("loginDialog").close());
    document.getElementById("registerCancelBtn").addEventListener("click", () => document.getElementById("registerDialog").close());
    document.getElementById("registerForm").addEventListener("submit", (e) => {
      e.preventDefault();
      safe(async () => {
        await register();
        document.getElementById("registerDialog").close();
      });
    });
    document.getElementById("loginForm").addEventListener("submit", (e) => {
      e.preventDefault();
      safe(async () => {
        await login();
        document.getElementById("loginDialog").close();
      });
    });
    document.getElementById("goDashboardBtn").addEventListener("click", async () => { await saveSettingsIfLoggedIn(); window.location.href = "/ui/dashboard"; });
    document.getElementById("logoutFirstBtn").addEventListener("click", () => safe(logout));
    document.getElementById("cookieNecessaryBtn").addEventListener("click", () => { localStorage.setItem("mf_cookie_consent", "necessary"); showCookieBannerIfNeeded(); });
    document.getElementById("cookieAcceptBtn").addEventListener("click", () => { localStorage.setItem("mf_cookie_consent", "all"); showCookieBannerIfNeeded(); });

    init();
  </script>
</body>
</html>

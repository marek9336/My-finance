<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Finance - Overview</title>
  <link rel="stylesheet" href="/ui/common.css" />
  <style>
    .kpi { border:1px solid var(--border); border-radius:12px; padding:12px; }
    .kpi .label { font-size:12px; color:var(--muted); }
    .kpi strong { font-size:24px; display:block; margin-top:4px; }
    details { border:1px solid var(--border); border-radius:12px; padding:10px; }
    details > summary { cursor:pointer; font-weight:600; }
    #mainChart { width:100%; height:320px; border:1px solid var(--border); border-radius:12px; background:#fff; }
    body.dark #mainChart, body.dark .mini-chart { background:#0f1f33; }
    .mini-charts { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:10px; margin-top:10px; }
    .mini-card { border:1px solid var(--border); border-radius:12px; padding:10px; }
    .mini-chart { width:100%; height:120px; border:1px solid var(--border); border-radius:8px; }
    .section-title { margin:0 0 8px 0; }
    .periodBtn.active { background:var(--primary); color:#fff; border-color:var(--primary); }
    .chart-wrap { position: relative; }
    .chart-meta { display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; color:var(--muted); font-size:12px; }
    .chart-tooltip {
      position:absolute;
      pointer-events:none;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:10px;
      box-shadow:var(--shadow);
      padding:8px 10px;
      font-size:12px;
      max-width:280px;
      display:none;
      z-index:20;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="topbar">
        <div class="top-left">
          <h1 id="title">Overview</h1>
          <p id="subtitle">Statuses, rates, charts and statistics.</p>
          <div class="menu-row">
            <a class="active" href="/ui/dashboard" id="navOverview">Overview</a>
            <a href="/ui/transactions" id="navTransactions">Transactions</a>
            <a href="/ui/savings-investments" id="navInvestments">Savings & Investments</a>
            <a href="/ui/rates" id="navRates">Rates</a>
            <a href="/ui/services" id="navServices">Services</a>
            <a href="/ui/settings" id="navSettings">Settings</a>
          </div>
        </div>
        <div class="top-actions">
          <div class="user-menu">
            <button id="userBtn" type="button">...</button>
            <div class="dropdown" id="userMenu">
              <a href="/ui/settings" id="menuSettingsLink">Settings</a>
              <button id="logoutBtn" class="logout" type="button">Logout</button>
            </div>
          </div>
        </div>
      </div>
      <div id="msg" class="msg"></div>
    </div>

    <div class="card">
      <h3 class="section-title" id="quickSummaryTitle">Quick Financial Summary</h3>
      <div class="grid">
        <div class="kpi"><div class="label" id="totalBalanceLabel">Total balance (all accounts)</div><strong id="totalBalance">0.00</strong></div>
        <div class="kpi"><div class="label" id="periodIncomeLabel">Income (selected period)</div><strong id="periodIncome">0.00</strong></div>
        <div class="kpi"><div class="label" id="periodExpenseLabel">Costs (selected period)</div><strong id="periodExpense">0.00</strong></div>
      </div>
      <details style="margin-top:10px;">
        <summary id="accountsDetailsSummary">Show account balances</summary>
        <div style="overflow:auto; margin-top:10px;"><table id="accountBalancesTable"></table></div>
      </details>
    </div>

    <div class="card">
      <h3 class="section-title" id="chartTitle">Total Balance Chart</h3>
      <div class="menu-row" style="margin-top:0; margin-bottom:10px;">
        <button data-period="week" class="periodBtn" type="button">7d</button>
        <button data-period="month" class="periodBtn active" type="button">30d</button>
        <button data-period="quarter" class="periodBtn" type="button">90d</button>
        <button data-period="year" class="periodBtn" type="button">365d</button>
        <button data-period="all" class="periodBtn" type="button">All</button>
        <span class="muted" id="chartRange" style="padding-top:8px;"></span>
      </div>
      <div class="chart-wrap">
        <canvas id="mainChart" width="1200" height="320"></canvas>
        <div id="chartTooltip" class="chart-tooltip"></div>
      </div>
      <div class="chart-meta">
        <span id="chartMin">Min: --</span>
        <span id="chartMax">Max: --</span>
      </div>
      <details style="margin-top:10px;">
        <summary id="accountChartsSummary">Show account charts</summary>
        <div id="accountCharts" class="mini-charts"></div>
      </details>
    </div>

    <div class="card">
      <h3 class="section-title" id="statsTitle">Statistics</h3>
      <div class="grid">
        <div>
          <h4 id="incomeCostTitle">Income / Costs / Free Cash</h4>
          <table id="incomeCostTable"></table>
        </div>
        <div>
          <h4 id="mainCategoriesTitle">Main Account Categories</h4>
          <table id="mainCategoryTable"></table>
        </div>
      </div>
      <div style="margin-top:12px;">
        <h4 id="accountTablesTitle">Account Tables (auto-generated)</h4>
        <div id="accountTables" class="grid"></div>
      </div>
    </div>

    <div class="card">
      <h3 class="section-title" id="ratesTitle">Rates Snapshot</h3>
      <p class="muted" style="margin-top:0;" id="ratesSubtitle">Configured watchlist from Rates page. Data source integration is next step.</p>
      <div style="overflow:auto;"><table id="ratesTable"></table></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3 class="section-title" id="debtsTitle">Receivables & Liabilities</h3>
        <p class="muted" id="debtsEmpty">No linked debt records yet. This section will be fed by tagged transactions.</p>
        <table id="debtsTable"></table>
      </div>
      <div class="card">
        <h3 class="section-title" id="servicesTitle">Service Repayments</h3>
        <p class="muted" id="servicesEmpty">No service repayment records yet. Tag transactions in Transactions page.</p>
        <table id="servicesTable"></table>
      </div>
    </div>

    <footer id="footerText">Copyright (c) My-Finance. Experimental software. Verify data and recommendations before acting.</footer>
  </div>

  <script src="/ui/common.js"></script>
  <script>
    let allAccounts = [];
    let allTransactions = [];
    let selectedPeriod = "month";
    let chartHitPoints = [];

    const t = (k, f="") => MFUI.t(k, f);

    function applyTexts() {
      document.title = t("dashboard.page_title", "My Finance - Overview");
      document.getElementById("title").textContent = t("dashboard.title", "Overview");
      document.getElementById("subtitle").textContent = t("dashboard.subtitle_overview", "Statuses, rates, charts and statistics.");
      document.getElementById("quickSummaryTitle").textContent = t("dashboard.quick_summary", "Quick Financial Summary");
      document.getElementById("totalBalanceLabel").textContent = t("dashboard.total_balance", "Total balance (all accounts)");
      document.getElementById("periodIncomeLabel").textContent = t("dashboard.period_income", "Income (selected period)");
      document.getElementById("periodExpenseLabel").textContent = t("dashboard.period_expense", "Costs (selected period)");
      document.getElementById("accountsDetailsSummary").textContent = t("dashboard.show_account_balances", "Show account balances");
      document.getElementById("chartTitle").textContent = t("dashboard.total_chart", "Total Balance Chart");
      document.getElementById("accountChartsSummary").textContent = t("dashboard.show_account_charts", "Show account charts");
      document.getElementById("statsTitle").textContent = t("dashboard.statistics", "Statistics");
      document.getElementById("incomeCostTitle").textContent = t("dashboard.income_cost_free", "Income / Costs / Free Cash");
      document.getElementById("mainCategoriesTitle").textContent = t("dashboard.main_categories", "Main Account Categories");
      document.getElementById("accountTablesTitle").textContent = t("dashboard.account_tables", "Account Tables (auto-generated)");
      document.getElementById("ratesTitle").textContent = t("dashboard.rates_snapshot", "Rates Snapshot");
      document.getElementById("ratesSubtitle").textContent = t("dashboard.rates_subtitle", "Configured watchlist from Rates page. Data source integration is next step.");
      document.getElementById("debtsTitle").textContent = t("dashboard.debts", "Receivables & Liabilities");
      document.getElementById("debtsEmpty").textContent = t("dashboard.debts_empty", "No linked debt records yet. This section will be fed by tagged transactions.");
      document.getElementById("servicesTitle").textContent = t("dashboard.services_repayments", "Service Repayments");
      document.getElementById("servicesEmpty").textContent = t("dashboard.services_empty", "No service repayment records yet. Tag transactions in Transactions page.");
      document.getElementById("chartMin").textContent = `${t("dashboard.chart_min", "Min")}: --`;
      document.getElementById("chartMax").textContent = `${t("dashboard.chart_max", "Max")}: --`;
      renderPeriodButtons();
    }

    function amountDirection(tx) { return tx.direction === "income" ? Number(tx.amount || 0) : -Number(tx.amount || 0); }
    function periodDays() { return selectedPeriod === "week" ? 7 : selectedPeriod === "month" ? 30 : selectedPeriod === "quarter" ? 90 : selectedPeriod === "year" ? 365 : null; }

    function buildDateRange() {
      const now = new Date();
      now.setHours(23, 59, 59, 999);
      const days = periodDays();
      if (!allTransactions.length) return { start: new Date(now.getTime() - 29 * 86400000), end: now };
      if (days) {
        const start = new Date(now.getTime() - (days - 1) * 86400000);
        start.setHours(0, 0, 0, 0);
        return { start, end: now };
      }
      const minTs = Math.min(...allTransactions.map((tx) => new Date(tx.occurredAt).getTime()));
      const start = new Date(minTs);
      start.setHours(0, 0, 0, 0);
      return { start, end: now };
    }

    function totalSeries() {
      const { start, end } = buildDateRange();
      const inRange = allTransactions.filter((tx) => {
        const ts = new Date(tx.occurredAt).getTime();
        return ts >= start.getTime() && ts <= end.getTime();
      });
      const dayImpact = new Map();
      inRange.forEach((tx) => {
        const key = new Date(tx.occurredAt).toISOString().slice(0, 10);
        dayImpact.set(key, (dayImpact.get(key) || 0) + amountDirection(tx));
      });
      const labels = [];
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        labels.push(new Date(d).toISOString().slice(0, 10));
      }
      const currentTotal = allAccounts.reduce((s, a) => s + Number(a.currentBalance || 0), 0);
      const txAfterStart = allTransactions
        .filter((tx) => {
          const ts = new Date(tx.occurredAt).getTime();
          return ts >= start.getTime() && ts <= end.getTime();
        })
        .reduce((s, tx) => s + amountDirection(tx), 0);
      let running = currentTotal - txAfterStart;
      const values = [];
      const txMarkers = [];
      labels.forEach((day) => {
        running += dayImpact.get(day) || 0;
        values.push(running);
        inRange.filter((tx) => new Date(tx.occurredAt).toISOString().slice(0, 10) === day).forEach((tx) => {
          txMarkers.push({ day, tx, value: running });
        });
      });
      const income = inRange.filter((t) => t.direction === "income").reduce((s, t) => s + Number(t.amount || 0), 0);
      const expense = inRange.filter((t) => t.direction === "expense").reduce((s, t) => s + Number(t.amount || 0), 0);
      return { labels, values, txMarkers, income, expense };
    }

    function drawMainChart() {
      const canvas = document.getElementById("mainChart");
      const ctx = canvas.getContext("2d");
      const { labels, values, txMarkers, income, expense } = totalSeries();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const pad = 36, w = canvas.width - pad * 2, h = canvas.height - pad * 2;
      ctx.strokeStyle = "#9cb5d3";
      ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, pad + h); ctx.lineTo(pad + w, pad + h); ctx.stroke();
      const min = Math.min(...values), max = Math.max(...values);
      const ys = (v) => pad + (max === min ? h / 2 : h - ((v - min) / (max - min)) * h);
      const xs = (i) => pad + (labels.length === 1 ? w / 2 : (i / (labels.length - 1)) * w);
      ctx.strokeStyle = "#0f6ecf";
      ctx.lineWidth = 2.2;
      ctx.beginPath();
      values.forEach((v, i) => { const x = xs(i), y = ys(v); if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); });
      ctx.stroke();
      chartHitPoints = [];
      ctx.fillStyle = "#0f6ecf";
      values.forEach((v, i) => {
        const x = xs(i), y = ys(v);
        ctx.beginPath(); ctx.arc(x, y, 2.4, 0, Math.PI * 2); ctx.fill();
        chartHitPoints.push({ x, y, type: "balance", day: labels[i], value: v });
      });
      txMarkers.forEach((m) => {
        const i = labels.indexOf(m.day);
        if (i < 0) return;
        const x = xs(i), y = ys(m.value);
        ctx.fillStyle = m.tx.direction === "income" ? "#1b8f47" : "#b3261e";
        ctx.beginPath(); ctx.arc(x, y, 4.2, 0, Math.PI * 2); ctx.fill();
        chartHitPoints.push({ x, y, type: "tx", day: m.day, value: m.value, tx: m.tx });
      });
      document.getElementById("chartRange").textContent = `${labels[0]} -> ${labels[labels.length - 1]}`;
      document.getElementById("periodIncome").textContent = income.toFixed(2);
      document.getElementById("periodExpense").textContent = expense.toFixed(2);
      document.getElementById("chartMin").textContent = `${t("dashboard.chart_min", "Min")}: ${Math.min(...values).toFixed(2)}`;
      document.getElementById("chartMax").textContent = `${t("dashboard.chart_max", "Max")}: ${Math.max(...values).toFixed(2)}`;
    }

    function drawMiniChart(canvas, values) {
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const pad = 16, w = canvas.width - pad * 2, h = canvas.height - pad * 2;
      ctx.strokeStyle = "#9cb5d3";
      ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, pad + h); ctx.lineTo(pad + w, pad + h); ctx.stroke();
      const min = Math.min(...values), max = Math.max(...values);
      const ys = (v) => pad + (max === min ? h / 2 : h - ((v - min) / (max - min)) * h);
      const xs = (i) => pad + (values.length === 1 ? w / 2 : (i / (values.length - 1)) * w);
      ctx.strokeStyle = "#1b8f47";
      ctx.beginPath();
      values.forEach((v, i) => { const x = xs(i), y = ys(v); if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); });
      ctx.stroke();
    }

    function renderAccountBalances() {
      const table = document.getElementById("accountBalancesTable");
      table.innerHTML = `<thead><tr><th>${t("dashboard.account", "Account")}</th><th>${t("dashboard.type", "Type")}</th><th>${t("dashboard.currency", "Currency")}</th><th>${t("dashboard.balance", "Balance")}</th></tr></thead><tbody></tbody>`;
      const tb = table.querySelector("tbody");
      allAccounts.forEach((a) => { const tr = document.createElement("tr"); tr.innerHTML = `<td>${a.name}</td><td>${t(`account.type.${a.accountType}`, a.accountType)}</td><td>${a.currency}</td><td>${Number(a.currentBalance || 0).toFixed(2)}</td>`; tb.appendChild(tr); });
      document.getElementById("totalBalance").textContent = allAccounts.reduce((s, a) => s + Number(a.currentBalance || 0), 0).toFixed(2);
    }

    function renderAccountCharts() {
      const wrap = document.getElementById("accountCharts");
      wrap.innerHTML = "";
      const { start, end } = buildDateRange();
      allAccounts.forEach((account) => {
        const txs = allTransactions
          .filter((t) => t.accountId === account.id)
          .sort((a, b) => new Date(a.occurredAt) - new Date(b.occurredAt));
        const inRange = txs.filter((t) => {
          const ts = new Date(t.occurredAt).getTime();
          return ts >= start.getTime() && ts <= end.getTime();
        });
        let running = Number(account.currentBalance || 0) - inRange.reduce((s, tx) => s + amountDirection(tx), 0);
        const byDay = new Map();
        inRange.forEach((tx) => { const day = new Date(tx.occurredAt).toISOString().slice(0, 10); byDay.set(day, (byDay.get(day) || 0) + amountDirection(tx)); });
        const days = [...byDay.keys()].sort();
        const values = [];
        days.forEach((day) => { running += byDay.get(day) || 0; values.push(running); });
        if (!values.length) values.push(Number(account.currentBalance || 0));
        const card = document.createElement("div");
        card.className = "mini-card";
        card.innerHTML = `<strong>${account.name}</strong><div class="muted">${t(`account.type.${account.accountType}`, account.accountType)} | ${account.currency}</div><canvas class="mini-chart" width="360" height="120"></canvas>`;
        wrap.appendChild(card);
        drawMiniChart(card.querySelector("canvas"), values);
      });
    }

    function classifyMainCategory(name) {
      const k = (name || "").toLowerCase();
      if (k.includes("invest")) return t("dashboard.cat_investments", "Investments");
      if (k.includes("potreb") || k.includes("need")) return t("dashboard.cat_needs", "Needs");
      if (k.includes("zbytec") || k.includes("want") || k.includes("fun")) return t("dashboard.cat_wants", "Wants");
      return t("dashboard.cat_living", "Living costs");
    }

    function renderStatisticsTables() {
      const now = new Date();
      const ym = `${now.getUTCFullYear()}-${String(now.getUTCMonth() + 1).padStart(2, "0")}`;
      const monthTx = allTransactions.filter((tx) => new Date(tx.occurredAt).toISOString().slice(0, 7) === ym);
      const monthIncome = monthTx.filter((t) => t.direction === "income").reduce((s, t) => s + Number(t.amount || 0), 0);
      const monthExpense = monthTx.filter((t) => t.direction === "expense").reduce((s, t) => s + Number(t.amount || 0), 0);
      const monthFree = monthIncome - monthExpense;
      document.getElementById("incomeCostTable").innerHTML = `<thead><tr><th>${t("dashboard.metric", "Metric")}</th><th>${t("dashboard.monthly", "Monthly")}</th><th>${t("dashboard.yearly", "Yearly (x12)")}</th></tr></thead><tbody><tr><td>${t("dashboard.income", "Income")}</td><td>${monthIncome.toFixed(2)}</td><td>${(monthIncome * 12).toFixed(2)}</td></tr><tr><td>${t("dashboard.costs", "Costs")}</td><td>${monthExpense.toFixed(2)}</td><td>${(monthExpense * 12).toFixed(2)}</td></tr><tr><td>${t("dashboard.free_cash", "Free cash")}</td><td>${monthFree.toFixed(2)}</td><td>${(monthFree * 12).toFixed(2)}</td></tr></tbody>`;
      const main = allAccounts.find((a) => a.accountType === "checking") || allAccounts[0];
      const mainTx = main ? allTransactions.filter((tx) => tx.accountId === main.id && tx.direction === "expense") : [];
      const buckets = {};
      [t("dashboard.cat_living", "Living costs"), t("dashboard.cat_investments", "Investments"), t("dashboard.cat_needs", "Needs"), t("dashboard.cat_wants", "Wants")].forEach((k) => (buckets[k] = 0));
      mainTx.forEach((tx) => { const key = classifyMainCategory(tx.category); buckets[key] = (buckets[key] || 0) + Number(tx.amount || 0); });
      document.getElementById("mainCategoryTable").innerHTML = `<thead><tr><th>${t("dashboard.category", "Category")}</th><th>${t("dashboard.amount", "Amount")}</th></tr></thead><tbody>${Object.entries(buckets).map(([k, v]) => `<tr><td>${k}</td><td>${v.toFixed(2)}</td></tr>`).join("")}</tbody>`;
      const wrap = document.getElementById("accountTables");
      wrap.innerHTML = "";
      allAccounts.forEach((account) => {
        const txs = allTransactions.filter((t) => t.accountId === account.id);
        const income = txs.filter((t) => t.direction === "income").reduce((s, t) => s + Number(t.amount || 0), 0);
        const expense = txs.filter((t) => t.direction === "expense").reduce((s, t) => s + Number(t.amount || 0), 0);
        const card = document.createElement("div");
        card.className = "kpi";
        card.innerHTML = `<strong>${account.name}</strong><div class="muted">${t(`account.type.${account.accountType}`, account.accountType)} | ${account.currency}</div><table style="margin-top:8px;"><thead><tr><th>${t("dashboard.income", "Income")}</th><th>${t("dashboard.costs", "Costs")}</th><th>${t("dashboard.free_cash", "Free cash")}</th></tr></thead><tbody><tr><td>${income.toFixed(2)}</td><td>${expense.toFixed(2)}</td><td>${(income - expense).toFixed(2)}</td></tr></tbody></table>`;
        wrap.appendChild(card);
      });
    }

    function parseTagsFromNote(note) {
      const text = (note || "").toLowerCase();
      return { debt: text.includes("debt:") || text.includes("dluh:"), service: text.includes("service:") || text.includes("sluzba:") };
    }

    function renderDebtAndServiceSections() {
      const debtRows = allTransactions.filter((tx) => parseTagsFromNote(tx.note).debt);
      const serviceRows = allTransactions.filter((tx) => parseTagsFromNote(tx.note).service);
      const debtTable = document.getElementById("debtsTable");
      if (!debtRows.length) {
        debtTable.innerHTML = "";
        document.getElementById("debtsEmpty").style.display = "block";
      } else {
        document.getElementById("debtsEmpty").style.display = "none";
        debtTable.innerHTML = `<thead><tr><th>${t("dashboard.date", "Date")}</th><th>${t("dashboard.direction", "Direction")}</th><th>${t("dashboard.amount", "Amount")}</th><th>${t("dashboard.currency", "Currency")}</th><th>${t("dashboard.note", "Note")}</th></tr></thead><tbody>${debtRows.map((tx) => `<tr><td>${new Date(tx.occurredAt).toISOString().slice(0, 10)}</td><td>${t(`transaction.direction.${tx.direction}`, tx.direction)}</td><td>${Number(tx.amount || 0).toFixed(2)}</td><td>${tx.currency}</td><td>${tx.note || ""}</td></tr>`).join("")}</tbody>`;
      }
      const servicesTable = document.getElementById("servicesTable");
      if (!serviceRows.length) {
        servicesTable.innerHTML = "";
        document.getElementById("servicesEmpty").style.display = "block";
      } else {
        document.getElementById("servicesEmpty").style.display = "none";
        servicesTable.innerHTML = `<thead><tr><th>${t("dashboard.date", "Date")}</th><th>${t("dashboard.amount", "Amount")}</th><th>${t("dashboard.currency", "Currency")}</th><th>${t("dashboard.note", "Note")}</th></tr></thead><tbody>${serviceRows.map((tx) => `<tr><td>${new Date(tx.occurredAt).toISOString().slice(0, 10)}</td><td>${Number(tx.amount || 0).toFixed(2)}</td><td>${tx.currency}</td><td>${tx.note || ""}</td></tr>`).join("")}</tbody>`;
      }
    }

    function renderRatesSnapshot() {
      const defaults = ["BTC", "ETH", "SOL", "SHIB", "ADA", "DOGE", "USD/CZK", "EUR/CZK"];
      const configured = JSON.parse(localStorage.getItem("mf_rates_watch") || "[]");
      const all = [...new Set([...defaults, ...configured])];
      const snapshot = JSON.parse(localStorage.getItem("mf_rates_snapshot") || "{}");
      document.getElementById("ratesTable").innerHTML = `<thead><tr><th>${t("rates.symbol", "Asset/Pair")}</th><th>${t("rates.price", "Price")}</th><th>${t("rates.currency", "Currency")}</th><th>${t("rates.last_update", "Last update")}</th></tr></thead><tbody>${all.map((symbol) => `<tr><td>${symbol}</td><td>${snapshot[symbol]?.price ?? "--"}</td><td>${snapshot[symbol]?.currency ?? "USD"}</td><td>${snapshot[symbol]?.updatedAt ?? t("rates.not_synced", "not synced")}</td></tr>`).join("")}</tbody>`;
    }

    function renderPeriodButtons() {
      const map = { week: "7d", month: "30d", quarter: "90d", year: "365d", all: t("dashboard.all", "All") };
      document.querySelectorAll(".periodBtn").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.period === selectedPeriod);
        btn.textContent = map[btn.dataset.period] || btn.dataset.period;
      });
    }

    async function refreshAll() {
      const [accounts, transactions] = await Promise.all([
        MFUI.api("/api/v1/accounts"),
        MFUI.api("/api/v1/transactions"),
      ]);
      allAccounts = accounts;
      allTransactions = transactions;
      renderAccountBalances();
      drawMainChart();
      renderAccountCharts();
      renderStatisticsTables();
      renderRatesSnapshot();
      renderDebtAndServiceSections();
    }

    function bindChartHover() {
      const canvas = document.getElementById("mainChart");
      const tooltip = document.getElementById("chartTooltip");
      const wrap = canvas.parentElement;
      canvas.addEventListener("mousemove", (e) => {
        if (!chartHitPoints.length) return;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;
        const nearest = chartHitPoints
          .map((p) => ({ p, d: Math.hypot(p.x - x, p.y - y) }))
          .filter((x0) => x0.d <= (x0.p.type === "tx" ? 10 : 7))
          .sort((a, b) => a.d - b.d)[0];
        if (!nearest) {
          tooltip.style.display = "none";
          return;
        }
        const h = nearest.p;
        if (h.type === "tx" && h.tx) {
          const accName = (allAccounts.find((a) => a.id === h.tx.accountId) || {}).name || "-";
          tooltip.innerHTML = `<strong>${h.day}</strong><br>${accName}<br>${t(`transaction.direction.${h.tx.direction}`, h.tx.direction)}: ${Number(h.tx.amount || 0).toFixed(2)} ${h.tx.currency}${h.tx.category ? `<br>${h.tx.category}` : ""}${h.tx.note ? `<br>${h.tx.note}` : ""}`;
        } else {
          tooltip.innerHTML = `<strong>${h.day}</strong><br>${t("dashboard.balance", "Balance")}: ${Number(h.value || 0).toFixed(2)}`;
        }
        tooltip.style.display = "block";
        tooltip.style.left = `${(e.clientX - wrap.getBoundingClientRect().left) + 12}px`;
        tooltip.style.top = `${(e.clientY - wrap.getBoundingClientRect().top) + 12}px`;
      });
      canvas.addEventListener("mouseleave", () => { tooltip.style.display = "none"; });
    }

    document.querySelectorAll(".periodBtn").forEach((btn) => {
      btn.addEventListener("click", () => {
        selectedPeriod = btn.dataset.period;
        renderPeriodButtons();
        drawMainChart();
        renderAccountCharts();
      });
    });

    (async () => {
      await MFUI.init();
      applyTexts();
      const safeRefresh = () => refreshAll().catch((e) => MFUI.setMsg(String(e.message || e), true));
      await safeRefresh();
      bindChartHover();
      MFUI.periodicRefresh(safeRefresh, 60000);
    })();
  </script>
</body>
</html>

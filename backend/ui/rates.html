<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Finance - Rates</title>
  <link rel="stylesheet" href="/ui/common.css" />
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="topbar">
        <div class="top-left">
          <h1 id="title">Rates</h1>
          <p id="subtitle"><span id="subtitleText">Configure visible symbols and manual fallback values.</span><span class="dev-flag" id="devRates" title="In development">⚠️</span></p>
          <div class="menu-row">
            <a href="/ui/dashboard" id="navOverview">Overview</a>
            <a href="/ui/transactions" id="navTransactions">Transactions</a>
            <a href="/ui/savings-investments" id="navInvestments">Savings & Investments</a>
            <a class="active" href="/ui/rates" id="navRates">Rates</a>
            <a href="/ui/services" id="navServices">Services</a>
            </div>
        </div>
        <div class="top-actions">
          <div class="user-menu">
            <button id="userBtn" type="button">...</button>
            <div class="dropdown" id="userMenu">
              <a href="/ui/settings" id="menuSettingsLink">Settings</a>
              <button id="logoutBtn" class="logout" type="button">Logout</button>
            </div>
          </div>
        </div>
      </div>
      <div id="msg" class="msg"></div>
    </div>

    <div class="card grid">
      <div>
        <h3 id="watchTitle">Watchlist</h3>
        <div class="menu-row">
          <input id="symbolInput" placeholder="BTC or USD/CZK" />
          <button id="addSymbolBtn" type="button">Add</button>
        </div>
      </div>
      <div>
        <h3 id="manualTitle">Manual Snapshot</h3>
        <div class="menu-row">
          <select id="snapshotSymbol"></select>
          <input id="snapshotPrice" type="number" step="0.00000001" placeholder="Price" />
          <input id="snapshotCurrency" value="USD" placeholder="Currency" />
          <button id="saveSnapshotBtn" type="button">Save</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 id="configuredTitle">Configured Symbols</h3>
      <div style="overflow:auto;"><table id="ratesTable"></table></div>
    </div>

    <footer id="footerText">Copyright (c) My-Finance. Experimental software. Verify data and recommendations before acting.</footer>
  </div>

  <script src="/ui/common.js"></script>
  <script>
    const t = (k, f="") => MFUI.t(k, f);
    const defaultSymbols = ["BTC","ETH","SOL","SHIB","ADA","DOGE","USD/CZK","EUR/CZK"];
    let state = { watchlist: [], snapshots: {} };
    let displayPrimary = "CZK";
    let displaySecondary = "USD";

    async function loadState() {
      state = await MFUI.api("/api/v1/rates");
      try {
        const appSettings = await MFUI.api("/api/v1/settings/app");
        displayPrimary = (appSettings.defaultDisplayCurrency || "CZK").toUpperCase();
        displaySecondary = (appSettings.secondaryDisplayCurrency || "USD").toUpperCase();
      } catch (_) {
        displayPrimary = "CZK";
        displaySecondary = "USD";
      }
      if (!state.watchlist || !state.watchlist.length) {
        state = await MFUI.api("/api/v1/rates/watchlist", "PUT", { symbols: defaultSymbols });
      }
    }

    function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : null; }
    function convertCurrency(value, src, target){
      const amount = toNum(value);
      if (amount === null) return null;
      const s = String(src || "").toUpperCase();
      const tCur = String(target || "").toUpperCase();
      if (!s || !tCur) return null;
      if (s === tCur) return amount;
      const snaps = state.snapshots || {};
      const direct = snaps[`${s}/${tCur}`];
      if (direct && String(direct.currency || "").toUpperCase() === tCur) {
        const rate = toNum(direct.price);
        if (rate && rate > 0) return amount * rate;
      }
      const inverse = snaps[`${tCur}/${s}`];
      if (inverse && String(inverse.currency || "").toUpperCase() === s) {
        const rate = toNum(inverse.price);
        if (rate && rate > 0) return amount / rate;
      }
      return null;
    }

    function applyTexts(){
      document.title = t("rates.page_title", "My Finance - Rates");
      document.getElementById("title").textContent = t("rates.title", "Rates");
      const subtitleText = document.getElementById("subtitleText");
      if (subtitleText) subtitleText.textContent = t("rates.subtitle", "Configure visible symbols and manual fallback values.");
      document.getElementById("watchTitle").textContent = t("rates.watchlist", "Watchlist");
      document.getElementById("manualTitle").textContent = t("rates.manual", "Manual Snapshot");
      document.getElementById("configuredTitle").textContent = t("rates.configured", "Configured Symbols");
      document.getElementById("addSymbolBtn").textContent = t("common.add", "Add");
      document.getElementById("saveSnapshotBtn").textContent = t("common.save", "Save");
      document.getElementById("symbolInput").placeholder = t("rates.symbol_placeholder", "BTC or USD/CZK");
      document.getElementById("snapshotPrice").placeholder = t("rates.price", "Price");
      document.getElementById("snapshotCurrency").placeholder = t("rates.currency", "Currency");
      const devRates = document.getElementById("devRates");
      if (devRates) devRates.title = t("common.in_development", "This part is still in development.");
    }

    function render(){
      const watch = state.watchlist || [];
      const snap = state.snapshots || {};
      const showSecondary = !!displaySecondary && displaySecondary !== displayPrimary;
      document.getElementById("ratesTable").innerHTML = `<thead><tr><th>${t("rates.symbol","Symbol")}</th><th>${t("rates.price","Price")} (${displayPrimary})</th>${showSecondary ? `<th>${t("rates.price","Price")} (${displaySecondary})</th>` : ""}<th>${t("rates.last_update","Last update")}</th><th>${t("dashboard.table.actions","Actions")}</th></tr></thead><tbody>${watch.map((s)=>{ const row=snap[s]; const srcCur=row?.currency || "USD"; const p1=convertCurrency(row?.price, srcCur, displayPrimary); const p2=showSecondary ? convertCurrency(row?.price, srcCur, displaySecondary) : null; return `<tr><td>${s}</td><td>${p1===null?"--":p1.toFixed(6)}</td>${showSecondary?`<td>${p2===null?"--":p2.toFixed(6)}</td>`:""}<td>${row?.updatedAt ?? t("rates.not_synced","not synced")}</td><td><button class="remove-rate" data-symbol="${s}" type="button">${t("common.delete","Delete")}</button></td></tr>`; }).join("")}</tbody>`;
      document.getElementById("snapshotSymbol").innerHTML = watch.map((s)=>`<option value="${s}">${s}</option>`).join("");
    }

    document.getElementById("addSymbolBtn").addEventListener("click",async ()=>{
      const input = document.getElementById("symbolInput");
      const sym = input.value.trim().toUpperCase();
      if(!sym) return;
      const symbols = [...new Set([...(state.watchlist || []), sym])];
      state = await MFUI.api("/api/v1/rates/watchlist", "PUT", { symbols });
      input.value = "";
      render();
      MFUI.setMsg(t("rates.added", "Symbol added."));
    });

    document.getElementById("saveSnapshotBtn").addEventListener("click",async ()=>{
      const sym = document.getElementById("snapshotSymbol").value;
      const price = Number(document.getElementById("snapshotPrice").value);
      const currency = (document.getElementById("snapshotCurrency").value || "USD").toUpperCase();
      if(!sym || Number.isNaN(price)) return MFUI.setMsg(t("rates.select_symbol_price", "Select symbol and price."), true);
      state = await MFUI.api("/api/v1/rates/snapshot","POST",{ symbol:sym, price, currency, source:"manual", updatedAt:new Date().toISOString() });
      render();
      MFUI.setMsg(t("rates.saved", "Snapshot saved."));
    });

    document.getElementById("ratesTable").addEventListener("click",async (e)=>{
      const btn = e.target.closest(".remove-rate");
      if(!btn) return;
      const symbol = btn.dataset.symbol;
      state = await MFUI.api(`/api/v1/rates/watchlist/${encodeURIComponent(symbol)}`,"DELETE");
      render();
      MFUI.setMsg(t("rates.removed", "Symbol removed."));
    });

    async function autoRefreshRates(silent = false) {
      const data = await MFUI.api("/api/v1/rates/refresh", "POST", {});
      state.snapshots = data.snapshots || {};
      render();
      if (!silent) MFUI.setMsg(`${t("common.refresh","Refresh")}: ${data.updated.length}`);
    }

    (async()=>{
      await MFUI.init();
      applyTexts();
      await loadState();
      render();
      await autoRefreshRates(true);
      MFUI.periodicRefresh(() => autoRefreshRates(true).catch(()=>{}), 15 * 60 * 1000);
    })().catch((e)=>MFUI.setMsg(MFUI.formatError(String(e.message||e)),true));
  </script>
</body>
</html>

